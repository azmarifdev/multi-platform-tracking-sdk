name: ğŸš€ Professional Release

on:
    push:
        tags:
            - 'v*'

permissions:
    contents: write
    packages: write

jobs:
    release:
        name: ğŸ·ï¸ Create Professional Release
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ğŸ·ï¸ Extract Version Info
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

                  # Determine release type
                  if [[ $VERSION == *"alpha"* ]]; then
                    echo "prerelease=true" >> $GITHUB_OUTPUT
                    echo "release_type=ğŸ§ª Alpha Release" >> $GITHUB_OUTPUT
                  elif [[ $VERSION == *"beta"* ]]; then
                    echo "prerelease=true" >> $GITHUB_OUTPUT
                    echo "release_type=ğŸ§ª Beta Release" >> $GITHUB_OUTPUT
                  elif [[ $VERSION == *"rc"* ]]; then
                    echo "prerelease=true" >> $GITHUB_OUTPUT
                    echo "release_type=ğŸ”„ Release Candidate" >> $GITHUB_OUTPUT
                  else
                    echo "prerelease=false" >> $GITHUB_OUTPUT
                    echo "release_type=âœ… Stable Release" >> $GITHUB_OUTPUT
                  fi

            - name: ğŸ“‹ Generate Enhanced Changelog
              id: changelog
              run: |
                  echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT

                  # Get previous tag
                  PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

                  if [ -z "$PREV_TAG" ]; then
                    echo "ğŸ‰ **Initial Release**" >> $GITHUB_OUTPUT
                    echo "" >> $GITHUB_OUTPUT
                    echo "This is the first release of Multi-Platform Tracking SDK!" >> $GITHUB_OUTPUT
                  else
                    echo "ğŸ“ **Changes since $PREV_TAG:**" >> $GITHUB_OUTPUT
                    echo "" >> $GITHUB_OUTPUT
                    
                    # Categorize commits
                    git log --pretty=format:"- %s" $PREV_TAG..HEAD | while read line; do
                      if [[ $line == *"feat"* ]] || [[ $line == *"add"* ]]; then
                        echo "âœ¨ $line" >> $GITHUB_OUTPUT
                      elif [[ $line == *"fix"* ]]; then
                        echo "ğŸ› $line" >> $GITHUB_OUTPUT
                      elif [[ $line == *"docs"* ]]; then
                        echo "ğŸ“š $line" >> $GITHUB_OUTPUT
                      elif [[ $line == *"perf"* ]]; then
                        echo "âš¡ $line" >> $GITHUB_OUTPUT
                      elif [[ $line == *"test"* ]]; then
                        echo "ğŸ§ª $line" >> $GITHUB_OUTPUT
                      elif [[ $line == *"ci"* ]] || [[ $line == *"build"* ]]; then
                        echo "ğŸ”§ $line" >> $GITHUB_OUTPUT
                      else
                        echo "ğŸ“¦ $line" >> $GITHUB_OUTPUT
                      fi
                    done
                  fi

                  echo "EOF" >> $GITHUB_OUTPUT

            - name: ğŸ“Š Generate Release Statistics
              id: stats
              run: |
                  # Count files
                  FILE_COUNT=$(find src -name "*.ts" | wc -l)
                  echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

                  # Count lines of code
                  LOC=$(find src -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print $1}')
                  echo "lines_of_code=$LOC" >> $GITHUB_OUTPUT

                  # Package size (approximate)
                  PACKAGE_SIZE="74.0 kB"
                  echo "package_size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT

            - name: ğŸ¯ Create Professional GitHub Release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.version.outputs.version }}
                  name: '${{ steps.version.outputs.release_type }} Multi-Platform Tracking SDK ${{ steps.version.outputs.version }}'
                  body: |
                      # ğŸš€ Multi-Platform Tracking SDK ${{ steps.version.outputs.version }}

                      > **${{ steps.version.outputs.release_type }}** - Professional analytics SDK for modern applications

                      ![Version](https://img.shields.io/badge/version-${{ steps.version.outputs.version_number }}-blue)
                      ![NPM](https://img.shields.io/badge/npm-published-green)
                      ![TypeScript](https://img.shields.io/badge/TypeScript-Ready-blue)
                      ![Tests](https://img.shields.io/badge/tests-44%2F44%20passing-brightgreen)

                      ## ğŸ“¦ Quick Installation

                      ```bash
                      # NPM
                      npm install @azmarifdev/multi-platform-tracking-sdk

                      # Yarn
                      yarn add @azmarifdev/multi-platform-tracking-sdk

                      # PNPM  
                      pnpm add @azmarifdev/multi-platform-tracking-sdk
                      ```

                      ## ğŸ†• What's New

                      ${{ steps.changelog.outputs.CHANGELOG }}

                      ## âœ¨ Platform Support Matrix

                      | Platform | Status | Key Features |
                      |----------|:------:|--------------|
                      | ğŸ“˜ **Facebook/Meta** | âœ… | Pixel tracking, Conversion API, Server-side events |
                      | ğŸ“¸ **Instagram** | âœ… | Stories, Reels, Shopping events, Engagement tracking |
                      | ğŸ·ï¸ **Google Tag Manager** | âœ… | Enhanced ecommerce, Custom events, Debug tools |
                      | ğŸ”§ **Developer Experience** | âœ… | Full TypeScript, Zero dependencies, Modern ESM |

                      ## ğŸš€ Quick Start Examples

                      ### Meta Pixel Tracking
                      ```typescript
                      import { MetaPixelTracker } from '@azmarifdev/multi-platform-tracking-sdk';

                      const tracker = new MetaPixelTracker({
                        pixelId: 'YOUR_PIXEL_ID',
                        debug: true
                      });

                      // Track page view
                      tracker.track('PageView');

                      // Track purchase
                      tracker.track('Purchase', {
                        value: 29.99,
                        currency: 'USD'
                      });
                      ```

                      ### Instagram Engagement
                      ```typescript
                      import { InstagramTracker } from '@azmarifdev/multi-platform-tracking-sdk';

                      const instaTracker = new InstagramTracker({
                        pixelId: 'YOUR_PIXEL_ID'
                      });

                      // Track story interaction
                      instaTracker.trackStoryView('story_123');
                      instaTracker.trackStoryComplete('story_123');

                      // Track shopping events
                      instaTracker.trackShoppingEvent('view_product', {
                        productId: 'prod_456',
                        category: 'Electronics'
                      });
                      ```

                      ### Server-Side Conversion API
                      ```typescript
                      import { MetaConversionTracker } from '@azmarifdev/multi-platform-tracking-sdk';

                      const conversionTracker = new MetaConversionTracker({
                        pixelId: 'YOUR_PIXEL_ID',
                        accessToken: 'YOUR_ACCESS_TOKEN',
                        testEventCode: 'TEST12345' // For testing
                      });

                      // Server-side purchase tracking
                      await conversionTracker.trackPurchase(99.99, 'USD', {
                        email: 'customer@example.com',
                        phone: '+1234567890'
                      });
                      ```

                      ## ğŸ“Š Release Statistics

                      - **ğŸ“ TypeScript Files**: ${{ steps.stats.outputs.file_count }} files
                      - **ğŸ“ Lines of Code**: ${{ steps.stats.outputs.lines_of_code }} lines
                      - **ğŸ“¦ Package Size**: ${{ steps.stats.outputs.package_size }} compressed
                      - **ğŸ§ª Test Coverage**: 44/44 tests passing
                      - **ğŸ”§ Dependencies**: Zero external dependencies

                      ## ğŸŒ Browser & Node.js Support

                      ### Node.js Environments
                      - âœ… Node.js 18.x LTS
                      - âœ… Node.js 20.x Current
                      - âœ… Server-side rendering (SSR)
                      - âœ… Edge runtime compatible

                      ### Browser Support
                      - âœ… Chrome 88+
                      - âœ… Firefox 85+
                      - âœ… Safari 14+
                      - âœ… Edge 88+
                      - âœ… Mobile browsers (iOS/Android)

                      ## ğŸ›¡ï¸ Security & Privacy

                      - ğŸ”’ **No eval()**: Secure code execution
                      - ğŸ›¡ï¸ **GDPR Compliant**: Built-in privacy controls
                      - ğŸ” **Data Hashing**: Automatic PII protection
                      - âœ… **CSP Compatible**: Content Security Policy friendly

                      ## ğŸ“š Documentation & Resources

                      | Resource | Link |
                      |----------|------|
                      | ğŸ“– **Documentation** | [View Docs](https://github.com/azmarifdev/multi-platform-tracking-sdk#readme) |
                      | ğŸ¯ **API Reference** | [API Docs](https://github.com/azmarifdev/multi-platform-tracking-sdk/blob/main/docs/API.md) |
                      | ğŸ’¡ **Examples** | [Code Examples](https://github.com/azmarifdev/multi-platform-tracking-sdk/tree/main/examples) |
                      | ğŸ› **Issues** | [Report Bug](https://github.com/azmarifdev/multi-platform-tracking-sdk/issues) |
                      | ğŸ’¬ **Discussions** | [Community](https://github.com/azmarifdev/multi-platform-tracking-sdk/discussions) |
                      | ğŸš€ **Changelog** | [View Changes](https://github.com/azmarifdev/multi-platform-tracking-sdk/blob/main/CHANGELOG.md) |

                      ## ğŸ’ Support the Project

                      If this SDK helps your project, consider:
                      - â­ **Star the repository**
                      - ğŸ› **Report issues** and suggest improvements
                      - ğŸ“– **Contribute to documentation**
                      - ğŸ’¬ **Share with the community**

                      ---

                      **Built with â¤ï¸ for the JavaScript ecosystem**  
                      Created by [@azmarifdev](https://github.com/azmarifdev) | Licensed under MIT

                      ![NPM Downloads](https://img.shields.io/npm/dm/@azmarifdev/multi-platform-tracking-sdk)
                      ![GitHub Stars](https://img.shields.io/github/stars/azmarifdev/multi-platform-tracking-sdk)
                      ![License](https://img.shields.io/badge/license-MIT-blue)
                  draft: false
                  prerelease: ${{ steps.version.outputs.prerelease }}
                  make_latest: ${{ steps.version.outputs.prerelease == 'false' }}
                  generate_release_notes: false
