name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
        tags: ['v*']
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [18.x, 20.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run quality checks
              run: npm run type-check

            - name: Run tests
              run: npm run test:ci

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella
              if: matrix.node-version == '18.x'

    build:
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build package
              run: npm run build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: dist-files
                  path: dist/

    release:
        runs-on: ubuntu-latest
        needs: [test, build]
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18.x'
                  cache: 'npm'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install dependencies
              run: npm ci

            - name: Build package
              run: npm run build

            - name: Extract version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Generate changelog from commits
              id: changelog
              run: |
                  echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
                  git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD~1)..HEAD >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.version.outputs.VERSION }}
                  name: 'Multi-Platform Tracking SDK ${{ steps.version.outputs.VERSION }}'
                  body: |
                      ## 🚀 Multi-Platform Tracking SDK ${{ steps.version.outputs.VERSION }}

                      > **Professional multi-platform analytics SDK for modern web applications**

                      ### 📦 Quick Installation:
                      ```bash
                      npm install @azmarifdev/multi-platform-tracking-sdk
                      ```
                      ```bash
                      yarn add @azmarifdev/multi-platform-tracking-sdk
                      ```

                      ### 🆕 What's New in ${{ steps.version.outputs.VERSION }}:
                      ${{ steps.changelog.outputs.CHANGELOG }}

                      ### ✨ Core Features:
                      | Platform | Status | Features |
                      |----------|--------|----------|
                      | 📘 **Facebook/Meta** | ✅ Ready | Pixel & Conversion API |
                      | 📸 **Instagram** | ✅ Ready | Stories, Reels, Shopping |
                      | 🏷️ **Google Analytics** | ✅ Ready | Tag Manager Integration |
                      | 🔧 **Developer Tools** | ✅ Ready | TypeScript, Zero Dependencies |

                      ### 🚀 Quick Start:
                      ```typescript
                      import { MetaPixelTracker, InstagramTracker } from '@azmarifdev/multi-platform-tracking-sdk';

                      // Initialize Meta Pixel
                      const metaTracker = new MetaPixelTracker({ pixelId: 'YOUR_PIXEL_ID' });
                      metaTracker.track('PageView');

                      // Instagram engagement tracking
                      const instaTracker = new InstagramTracker({ pixelId: 'YOUR_PIXEL_ID' });
                      instaTracker.trackStoryView('story_id');
                      ```

                      ### � Performance Metrics:
                      - **Bundle Size**: 74.0 kB compressed
                      - **Test Coverage**: 44/44 tests passing
                      - **TypeScript**: Full type safety
                      - **Zero Dependencies**: No external libraries

                      ### 🌍 Platform Support:
                      - ✅ **Node.js**: 18.x, 20.x+
                      - ✅ **Browsers**: Modern ES2020+
                      - ✅ **Frameworks**: React, Vue, Angular, Vanilla JS

                      ### 📚 Resources:
                      - 📖 [Complete Documentation](https://github.com/azmarifdev/multi-platform-tracking-sdk#readme)
                      - 🛠️ [API Reference](https://github.com/azmarifdev/multi-platform-tracking-sdk/blob/main/docs/API.md)
                      - 💡 [Examples & Tutorials](https://github.com/azmarifdev/multi-platform-tracking-sdk/tree/main/examples)
                      - 🐛 [Report Issues](https://github.com/azmarifdev/multi-platform-tracking-sdk/issues)
                      - 💬 [Community Discussions](https://github.com/azmarifdev/multi-platform-tracking-sdk/discussions)

                      ### 🏆 Enterprise Ready:
                      - 🔒 **Security**: No eval(), GDPR compliant
                      - 🚀 **Performance**: Optimized for production
                      - 🧪 **Reliability**: Comprehensive test suite
                      - 📈 **Scalability**: Support for high-volume tracking

                      ---

                      **Built with ❤️ for the JavaScript community**  
                      Created by [@azmarifdev](https://github.com/azmarifdev) | Licensed under MIT
                  draft: false
                  prerelease: false
                  make_latest: true
                  generate_release_notes: false

            - name: Publish to NPM
              run: npm publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
