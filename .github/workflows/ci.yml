name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
        tags: ['v*']
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [18.x, 20.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run quality checks
              run: npm run type-check

            - name: Run tests
              run: npm run test:ci

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella
              if: matrix.node-version == '18.x'

    build:
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build package
              run: npm run build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: dist-files
                  path: dist/

    release:
        runs-on: ubuntu-latest
        needs: [test, build]
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18.x'
                  cache: 'npm'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install dependencies
              run: npm ci

            - name: Build package
              run: npm run build

            - name: Extract version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Generate changelog from commits
              id: changelog
              run: |
                  echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
                  git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD~1)..HEAD >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create GitHub Release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.version.outputs.VERSION }}
                  release_name: Multi-Platform Tracking SDK ${{ steps.version.outputs.VERSION }}
                  body: |
                      ## 🚀 Multi-Platform Tracking SDK ${{ steps.version.outputs.VERSION }}

                      ### 📦 Installation:
                      ```bash
                      npm install @azmarifdev/multi-platform-tracking-sdk
                      ```

                      ### 🔄 Changes in this release:
                      ${{ steps.changelog.outputs.CHANGELOG }}

                      ### 🌟 Features:
                      - ✅ Facebook/Meta Pixel & Conversion API
                      - ✅ Instagram Tracking (Stories, Reels, Shopping)  
                      - ✅ Google Tag Manager Integration
                      - ✅ TypeScript Support
                      - ✅ Zero Dependencies

                      ### 📚 Documentation:
                      [View Complete Documentation](https://github.com/azmarifdev/multi-platform-tracking-sdk#readme)

                      ### 🤝 Support:
                      - [Report Issues](https://github.com/azmarifdev/multi-platform-tracking-sdk/issues)
                      - [Discussions](https://github.com/azmarifdev/multi-platform-tracking-sdk/discussions)
                  draft: false
                  prerelease: false

            - name: Publish to NPM
              run: npm publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
